name: Release (Tauri)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: tauri-release
  cancel-in-progress: true

jobs:
  prepare:
    if: github.event_name == 'workflow_dispatch' || (github.actor != 'github-actions[bot]' && !startsWith(github.event.head_commit.message, 'chore(release):'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      bump_type: ${{ steps.version.outputs.type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide bump type
        id: bump
        run: |
          MSG=$(git log -1 --pretty=%s)
          TYPE="patch"
          shopt -s nocasematch
          if [[ "$MSG" == major* ]]; then
            TYPE="major"
          elif [[ "$MSG" == minor* ]]; then
            TYPE="minor"
          fi
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"

      - name: Compute next version
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "${{ steps.bump.outputs.type }}" in
            major)
              MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
              ;;
            minor)
              MINOR=$((MINOR+1)); PATCH=0
              ;;
            patch|*)
              PATCH=$((PATCH+1))
              ;;
          esac
          NEXT="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEXT" >> "$GITHUB_OUTPUT"
          echo "type=${{ steps.bump.outputs.type }}" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            rpm

      - name: Install dependencies
        run: npm ci

      - name: Set version
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version
          node -e 'const fs=require("fs");const file="src-tauri/tauri.conf.json";const data=JSON.parse(fs.readFileSync(file,"utf8"));data.version="${{ needs.prepare.outputs.version }}";fs.writeFileSync(file, JSON.stringify(data, null, 2)+"\n");'
          node -e 'const fs=require("fs");const file="src-tauri/Cargo.toml";let data=fs.readFileSync(file,"utf8");data=data.replace(/^version\\s*=\\s*\"[^\"]+\"/m, "version = \"${{ needs.prepare.outputs.version }}\"");fs.writeFileSync(file,data);'

      - name: Build
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: keyboarder-${{ matrix.os }}
          path: target/release/bundle/**

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Apply version bump
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version
          node -e 'const fs=require("fs");const file="src-tauri/tauri.conf.json";const data=JSON.parse(fs.readFileSync(file,"utf8"));data.version="${{ needs.prepare.outputs.version }}";fs.writeFileSync(file, JSON.stringify(data, null, 2)+"\n");'
          node -e 'const fs=require("fs");const file="src-tauri/Cargo.toml";let data=fs.readFileSync(file,"utf8");data=data.replace(/^version\\s*=\\s*\"[^\"]+\"/m, "version = \"${{ needs.prepare.outputs.version }}\"");fs.writeFileSync(file,data);'

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json src-tauri/tauri.conf.json src-tauri/Cargo.toml src-tauri/Cargo.lock
          git commit -m "chore(release): v${{ needs.prepare.outputs.version }}"
          git push

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: keyboarder-ubuntu-24.04
          path: artifacts/linux

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: keyboarder-windows-latest
          path: artifacts/windows

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ needs.prepare.outputs.version }}"
          mkdir -p uploads
          keep_asset() {
            case "$1" in
              *.AppImage|*.appimage|*.deb|*.rpm|*.msi|*.exe) return 0 ;;
              *) return 1 ;;
            esac
          }
          for file in $(find artifacts/linux -type f); do
            keep_asset "$file" || continue
            base=$(basename "$file")
            cp "$file" "uploads/linux-${base}"
          done
          for file in $(find artifacts/windows -type f); do
            keep_asset "$file" || continue
            base=$(basename "$file")
            cp "$file" "uploads/windows-${base}"
          done
          TARGET=$(git rev-parse HEAD)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists, replacing assets..."
          else
            gh release create "$TAG" --title "$TAG" --generate-notes --target "$TARGET"
          fi
          for file in uploads/*; do
            [ -e "$file" ] || continue
            name=$(basename "$file")
            asset_id=$(gh release view "$TAG" --json assets --jq ".assets[] | select(.name==\"$name\") | .id")
            if [ -n "$asset_id" ]; then
              gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/assets/${asset_id}"
            fi
            gh release upload "$TAG" "$file"
          done
